% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/get_fcip_agents.R
\name{get_fcip_agents}
\alias{get_fcip_agents}
\title{Build FCIP record-level dataset for a commodity year from calibration artifacts and RMA reference tables}
\usage{
get_fcip_agents(
  year,
  relevant_adm,
  relevant_sob,
  keep_variables = NULL,
  temporary_dir = tempdir()
)
}
\arguments{
\item{year}{Integer. Commodity year to process (e.g., 2015).}

\item{relevant_adm}{data.table. Pre-filtered administrative table defining the
set of relevant insurance pools. Must contain at least
\code{state_code}, \code{county_code}, \code{commodity_code}, \code{type_code}, and
\code{practice_code}.}

\item{relevant_sob}{data.table. Pre-filtered SOB/TPU-style table used to
construct \code{producer_id} and to join reference records into the revenue-draw
data. Must contain the fields required to build \code{producer_id}:
\code{state_code}, \code{county_code}, \code{commodity_code}, \code{type_code}, \code{practice_code},
\code{unit_structure_code}, \code{insurance_plan_code}, \code{coverage_type_code},
\code{coverage_level_percent}. If present, \code{commodity_year} may also be used
in joins.}

\item{keep_variables}{Character vector of additional column names to retain
(if present after all joins and filtering). Default is \code{NULL}.}

\item{temporary_dir}{Character. Directory used to store downloaded calibration
artifacts. Defaults to \code{tempdir()}. The directory will be created if it does
not exist.}
}
\value{
A \code{data.table} containing one row per retained FCIP record, including identifying
keys, selected calibration and draw fields, observed premium and subsidy
measures, projected price, and any variables listed in \code{keep_variables} that
exist. Returns \code{NULL} if an error occurs.
}
\description{
Downloads year-specific calibration artifacts from GitHub (revenue draws,
calibrated yields, and compressed projected prices), restricts revenue-draw
records to insurance pools present in \code{relevant_adm}, joins SOB/TPU reference
records from \code{relevant_sob} using explicit and validated keys, computes observed
premium-rate and subsidy-share measures, attaches yield and price fields,
filters invalid records, and returns a streamlined \code{data.table}.
}
\details{
The function expects calibration artifacts to be available as GitHub release
assets with the following structure:

\itemize{
\item Repository \code{ftsiboe/rfcipCalibrate}, tag \code{revenue_draw}:
\verb{revenue_draw_<year>.rds}
\item Repository \code{ftsiboe/rfcipCalibrate}, tag \code{calibrated_yield}:
\verb{calibrated_yield_<year>.rds}
\item Repository \code{ftsiboe/rfcipCalcPass}, tag \code{adm_compressed}:
\verb{<year>_A00810_Price.rds}
}

Revenue-draw records are first restricted to insurance pools observed in
\code{relevant_adm}. SOB/TPU records are then joined \strong{into} the revenue-draw data
(inner join), ensuring the unit of observation remains the revenue-draw /
policy-unit record.

Observed ratios are computed using NA-safe denominators:
\itemize{
\item \code{observed_premium_rate = total_premium_amount / liability_amount}
(rounded to 8 decimals)
\item \code{observed_subsidy_percent = subsidy_amount / total_premium_amount}
(rounded to 3 decimals)
}
Denominators that are non-finite, \code{NA}, or non-positive yield \code{NA_real_}.

Projected prices are aggregated to the mean by
\code{commodity_year}, \code{state_code}, \code{county_code}, \code{commodity_code}, \code{type_code},
and \code{practice_code}, and are left-joined into the output so no additional rows
are created.

The function filters out records with non-finite \code{calibrated_yield} values.
Records with missing observed ratios are retained.

Convenience columns are added for downstream FCIP pipelines:
\code{planted_acres = insured_acres}, and \code{price_election}, \code{insured_share}, and
\code{damage_area_rate} are set to 1.
}
\section{Side effects and requirements}{

\itemize{
\item Downloads external files using \code{piggyback::pb_download()}.
\item Reads and writes temporary RDS files in \code{temporary_dir}.
\item Requires the calibration artifacts to be accessible via GitHub releases.
}
}

