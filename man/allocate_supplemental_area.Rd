% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/build_supplemental_adoption_dynamics.R
\name{allocate_supplemental_area}
\alias{allocate_supplemental_area}
\title{Allocate Supplemental Area and Eligible Acres for a Supplemental Product Stub}
\usage{
allocate_supplemental_area(
  sob,
  base_policy_codes,
  supplemental_codes,
  supplemental_name,
  disaggregates = NULL,
  base_anchor = NULL,
  track_base_plan = TRUE,
  track_base_coverage_level = TRUE,
  split_by_coverage_level = FALSE
)
}
\arguments{
\item{sob}{A \code{data.table} containing the full SOB-TPU extract (base and supplemental
records). Must include \code{endorsed_acres}, \code{insured_acres},
\code{insurance_plan_code}, and the identifier columns referenced in \code{disaggregates}.}

\item{base_policy_codes}{Integer vector of base plan codes defining the denominator
acreage universe used to compute \code{eligible_acres}.}

\item{supplemental_codes}{Integer vector of SOB insurance plan codes identifying the
supplemental product(s) whose endorsed acres form \code{supplemental_area}.}

\item{supplemental_name}{Character scalar used to construct \code{supplemental_plan} when
\code{split_by_coverage_level = FALSE}.}

\item{disaggregates}{Optional character vector defining the primary aggregation grain.
Defaults to \code{c("commodity_year","state_code","county_code","commodity_code")}.}

\item{base_anchor}{Optional integer used to re-anchor stacked plan codes to base plan codes.}

\item{track_base_plan}{Logical. If \code{TRUE}, aggregates separately by
\code{insurance_plan_code} (after optional anchoring).}

\item{track_base_coverage_level}{Logical. If \code{TRUE}, aggregates separately by
\code{coverage_level_percent}.}

\item{split_by_coverage_level}{Logical. If \code{TRUE}, encode coverage into
\code{supplemental_plan} labels (e.g., \code{"eco90"}) rather than retaining
\code{coverage_level_percent} as a key column.}
}
\value{
A \code{data.table} containing the requested identifiers, \code{supplemental_plan},
and the level variables \code{supplemental_area} and \code{eligible_acres}.
}
\description{
Aggregates supplemental endorsed acres (\code{supplemental_area}) for selected
\code{supplemental_codes} and aggregates base insured acres (\code{eligible_acres}) for
selected \code{base_policy_codes}, at a common disaggregation grain, returning a long
table keyed by identifiers and a \code{supplemental_plan} label.

This is a low-level helper used by \code{get_supplemental_area()} and
\code{build_supplemental_adoption_dynamics()} to construct product- and
coverage-specific adoption totals.
}
\details{
The function implements the following steps:
\enumerate{
\item \strong{Supplemental aggregation (numerator):} Filters \code{sob} to
\code{supplemental_codes} and aggregates \code{endorsed_acres} to form
\code{supplemental_area} at the requested disaggregation level. Depending on settings,
aggregation may additionally track the base plan (\code{insurance_plan_code}) and/or the
base coverage level (\code{coverage_level_percent}).

\item \strong{Plan-code anchoring (optional):} If \code{base_anchor} is supplied,
\code{insurance_plan_code} is shifted by subtracting the anchor value. This is typically
used to map stacked-plan codes back onto underlying base plans (e.g., SCO 31-33 -> base
plans 1-3 by subtracting 30).

\item \strong{Coverage-specific labeling (optional):} If \code{split_by_coverage_level = TRUE},
constructs \code{supplemental_plan} labels using \code{coverage_level_percent} (e.g.,
\code{"eco90"}, \code{"eco95"}) and removes \code{coverage_level_percent} from the
aggregation grain so coverage becomes encoded in the label rather than the keys.

\item \strong{Base aggregation (denominator):} Aggregates \code{insured_acres} for
\code{base_policy_codes} to form \code{eligible_acres} at the same disaggregation grain.

\item \strong{Join and bounds:} Inner-joins numerator and denominator on shared identifiers,
drops rows with \code{eligible_acres == 0}, and enforces \code{supplemental_area <= eligible_acres}.
}
}
