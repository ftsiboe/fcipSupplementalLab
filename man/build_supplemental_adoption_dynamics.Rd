% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/build_supplemental_adoption_dynamics.R
\name{build_supplemental_adoption_dynamics}
\alias{build_supplemental_adoption_dynamics}
\title{Build County-Level Supplemental Insurance Eligibility, Offering, and Adoption Dynamics}
\usage{
build_supplemental_adoption_dynamics(sob, supplemental_stubs = NULL)
}
\arguments{
\item{sob}{A \code{data.frame} or \code{data.table} containing (at minimum)
\code{commodity_year}, \code{state_code}, \code{county_code}, \code{commodity_code},
\code{supplemental_plan}, \code{eligible_acres}, and \code{supplemental_area}.}

\item{supplemental_stubs}{Optional named list defining which supplemental products to
include. Each element must be a list with:
\itemize{
\item \code{offering_codes}: insurance plan codes indicating the product is offered in ADM
\item \code{eligible_codes}: insurance plan codes indicating the county is eligible in ADM
}
If \code{NULL}, a default set is constructed for SCO, STAX, MP, ECO (90/95), HIP-WI, PACE,
and FIP-SI (with plan-code ranges as specified in the function body).}
}
\value{
A \code{data.table} with one row per
\code{commodity_year} x \code{state_code} x \code{county_code} x \code{commodity_code}
x \code{supplemental_plan} containing:
\itemize{
\item \code{eligible}: 0/1 indicator for eligibility in ADM
\item \code{supplemental_offered}: 0/1 indicator for offering availability in ADM
\item \code{eligible_acres}: aggregated base-policy eligible/insured acres denominator
\item \code{supplemental_acres}: aggregated supplemental acres (\code{supplemental_area})
\item \code{county_fips}: 5-digit county FIPS (character)
\item \code{supplemental_plan}: stub name (character)
}
}
\description{
Builds a county-year-commodity panel describing \strong{(i) eligibility}, \strong{(ii) offering
availability}, and \strong{(iii) adoption intensity} for selected FCIP supplemental insurance
products.

This function expects a \strong{pre-processed SOB/TPU-style} dataset that already contains
stub-level adoption measures in:
\itemize{
\item \code{supplemental_plan}: a stub identifier (e.g., \code{"sco"}, \code{"eco90"})
\item \code{eligible_acres}: the base-policy eligible/insured acres denominator
\item \code{supplemental_area}: the supplemental endorsed/acquired acres numerator
}

The function then augments these adoption totals with county-level \strong{availability flags}
derived from RMA ADM insurance offer records (\code{A00030_InsuranceOffer}).
}
\details{
For each stub name in \code{supplemental_stubs}, the function:
\enumerate{
\item Filters \code{sob} to records whose \code{supplemental_plan} matches the stub name
(via \code{grepl()}) and aggregates \code{eligible_acres} and \code{supplemental_area} to
\code{commodity_year} x \code{state_code} x \code{county_code} x \code{commodity_code}
(retaining \code{supplemental_plan}).

\item Downloads ADM \code{A00030_InsuranceOffer} for each year present in \code{sob}
(via \code{rfcip::get_adm_data()}) and constructs two binary flags:
\itemize{
\item \code{eligible}: equals 1 if any record exists with
\code{insurance_plan_code} in \code{eligible_codes}
\item \code{offered}: equals 1 if any record exists with
\code{insurance_plan_code} in \code{offering_codes}
}
These indicators are collapsed using a \code{max()} rule within each county-year-commodity.
A companion 'all-commodities' version (\code{commodity_code = 0}) is also appended.

\item Builds a complete county shell from ADM \code{A00440_County} for each year and
crosses it with the set of \code{(commodity_year, commodity_code)} pairs present in the
ADM availability table so counties with zero insured/adopted acres are retained.

\item Left-joins availability flags to the county shell, then joins adoption totals from
\code{sob}. Missing numeric fields are set to 0. The function enforces basic bounds such
as \code{supplemental_acres <= eligible_acres}.
}

The returned object stacks all stub-specific panels into one long table with a
\code{supplemental_plan} identifier.
}
