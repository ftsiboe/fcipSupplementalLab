% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/build_supplemental_adoption_dynamics.R
\name{get_supplemental_shares}
\alias{get_supplemental_shares}
\title{Compute Supplemental Product Shares Relative to a Base Insured-Acres Denominator}
\usage{
get_supplemental_shares(
  sob_base,
  sob_full,
  supplemental_codes,
  supplemental_name,
  disaggregates = NULL,
  base_anchor = NULL,
  track_base_plan = TRUE,
  track_base_coverage_level = TRUE,
  split_by_coverage_level = FALSE
)
}
\arguments{
\item{sob_base}{A \code{data.table} containing \strong{base-policy outcomes} used as the
denominator. Must include \code{insured_acres} and the identifier columns needed
to form merge keys.}

\item{sob_full}{A \code{data.table} containing the \strong{full SOB-TPU extract}
(base and supplemental records). Must include \code{endorsed_acres},
\code{insurance_plan_code}, and the identifier columns referenced in
\code{disaggregates}.}

\item{supplemental_codes}{Integer vector of SOB insurance plan codes
identifying the supplemental product(s) whose adoption is to be measured.}

\item{supplemental_name}{Character scalar used to construct output column
names. The suffix \code{"_share"} is appended internally.}

\item{disaggregates}{Optional character vector defining the primary
aggregation grain. Defaults to
\code{c("commodity_year","state_code","county_code","commodity_code", "type_code","practice_code")}.}

\item{base_anchor}{Optional integer used to re-anchor stacked plan codes to
base plan codes.}

\item{track_base_plan}{Logical. If \code{TRUE}, adoption shares are computed
separately by base insurance plan.}

\item{track_base_coverage_level}{Logical. If \code{TRUE}, adoption shares are
computed separately by base coverage level.}

\item{split_by_coverage_level}{Logical. If \code{TRUE}, returns separate share
columns by coverage level percent.}
}
\value{
A \code{data.frame} (resulting from \code{tidyr} reshaping) containing the
requested identifiers and one or more wide columns ending in \code{"_share"}.
}
\description{
Computes \strong{supplemental adoption measures} by expressing supplemental acres as a
fraction of \strong{base insured acres} from a companion base dataset. This function is a
low-level helper used by \code{calculate_supplemental_adoption()} to construct product-level
uptake variables such as \code{sco_share}, \code{pace_share}, \code{hipwi_share}, or coverage-specific
measures like \code{eco90_share} and \code{eco95_share}.
}
\details{
The function implements the following steps:

\enumerate{
\item \strong{Supplemental aggregation (numerator):} Filters \code{sob_full} to
\code{supplemental_codes} and aggregates \code{endorsed_acres} to form
\code{supplemental_area} at the requested disaggregation level. Depending on
user settings, aggregation may additionally track the base plan
(\code{insurance_plan_code}) and/or the base coverage level
(\code{coverage_level_percent}).

\item \strong{Plan-code anchoring (optional):} If \code{base_anchor} is supplied,
\code{insurance_plan_code} is shifted by subtracting the anchor value. This is
typically used to map stacked-plan codes back onto their underlying base
plans (e.g., SCO codes 31-33 -> base plans 1-3 by subtracting 30).

\item \strong{Base aggregation (denominator):} Aggregates \code{sob_base} to the
intersection of keys shared with the supplemental aggregation and computes
total \code{insured_acres} for use as the denominator.

\item \strong{Share construction:} Computes
\code{supplemental_share = supplemental_area / insured_acres} when
\code{insured_acres > 0}; otherwise assigns \code{NA}.

\item \strong{De-duplication and reshaping:} If multiple rows exist for the same
identifier set and coverage label, the function collapses duplicates by
taking the \strong{mean} share within each identifier group before reshaping to
wide format.
}

If \code{split_by_coverage_level = TRUE}, output columns are labeled by coverage
level percent (rounded) and named
\verb{<supplemental_name><CL>_share} (e.g., \code{eco90_share}). In this case,
\code{coverage_level_percent} is removed from merge keys so that shares vary only
along the remaining disaggregation dimensions.

All non-finite share values (NA, Inf, -Inf, NaN) are coerced to \strong{0} in the
final output.
}
